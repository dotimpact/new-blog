title: ニコニコ動画のコメントを再現する動画をつくる
date: 2016-07-28
pid: d5fed3de0229c7c324721a2dd7ebcebd
status: p
tags:
- blog
---

奥さんが通っている映画学校の課題でニコ生がモチーフの映画を撮っているのだそうで、撮影した実写素材にニコ動風のコメントを流したいんだけど…という話をしていたのでそういうソリューションがあるのかちょっと調べた（AEでコメントを全部動かすつもりだったみたいけど、それは大変なので）。

ニコ動風コメントをPCやブラウザ上で再現するツールはいろいろあるみたいだけど、Macで動画保存（あとで撮影素材と合成するのでグリーンバックにコメントだけ流れる動画ファイル作れるのが望ましい）のことを考えると「[jikkyo - ニコニコ風実況アプリ][1]」がよさそうだった。nw.jsで作られたユニバーサルアプリで、本来は透明ウインドウに流れる保存されたコメントを別アプリで流している動画に重ねて鑑賞する目的のアプリなんだけど、背景色を任意で変えられるのであとで抜く色にしておいてQuickTimeの画面収録機能とかでキャプチャすれば合成用コメント動画が作れた。

ニコ動のコメントデータ構造というのも知らなかったんだけど、

<?xml version="1.0" encoding="UTF-8"?>
<packet>
	<thread last_res="xxxx" resultcode="0" revision="2" server_time="xxxxxx" thread="111111" ticket="xxxx"/>
	<view_counter id="smXXXXXX" mylist="xxxx" video="xxxxx"/>
	<chat anonymity="1" date="1202708675" mail="184" no="9661" thread="111111" user_id="xxx" vpos="0">こんなかんじ</chat>
	...

みたいな感じになって、chatタグのvposに動画先頭からのコメント出現位置（1/100秒単位）を指定してやればよいみたい。あと`mail`というプロパティがなぜかコメントの修飾コマンドになっているらしく（歴史的経緯がありそう）、`mail=" ue red"`みたいに書いてやれば色付きコメントができるっぽい。コマンドについては「[ニコニコAPIリストwiki - ニコ生コメント][2]」とかにくわしく書いてあった。

[1]:	https://rot1024.github.io/jikkyo/
[2]:	http://www59.atwiki.jp/nicoapi/pages/20.html